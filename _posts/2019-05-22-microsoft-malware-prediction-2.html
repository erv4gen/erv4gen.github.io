---
layout: post
title: Microsoft Malware Prediction
date: 2019-05-22 11:54:35.000000000 +00:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Data Science
tags: []
meta:
  _us_jsoncss_data: ''
  _us_in_content_ids: ''
  us_og_image: ''
  _us_grid_filter_atts: ''
  _edit_last: '1'
  _wp_page_template: default
  _wp_old_date: '2023-11-22'
  _oembed_e6892fe64cdcebf3ce48137c93deccd1: "{{unknown}}"
  _thumbnail_id: '9129'
  footnotes: ''
  _oembed_1abf1029f1300b6c06da301cef229357: "{{unknown}}"
  us_header_id: __defaults__
  us_header_sticky_override: ''
  us_header_sticky: ''
  us_header_transparent_override: ''
  us_header_transparent: ''
  us_header_shadow: ''
  us_header_sticky_pos: ''
  us_content_id: __defaults__
  us_footer_id: __defaults__
  us_tile_additional_image: ''
  us_tile_link: '{"url":"","target":""}'
  us_tile_icon: ''
  us_tile_size: 1x1
  us_tile_bg_color: ''
  us_tile_text_color: ''
  us_meta_title: ''
  us_meta_description: ''
  us_meta_robots: ''
author:
  login: Vladimir
  email: eremin.vladimir.d@gmail.com
  display_name: Vladimir
  first_name: ''
  last_name: ''
permalink: "/microsoft-malware-prediction-2/"
---
<p><!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd"><br />
<!-- wp:paragraph --><html><body></p>
<p>Kaggle <a href="https://www.kaggle.com/c/microsoft-malware-prediction">Competition</a> </p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Format: Playground</p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p>Code used : </p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:list --></p>
<ul>
<!-- wp:list-item --></p>
<li>https://www.kaggle.com/bogorodvo</li>
<p><!-- /wp:list-item --></p>
<p><!-- wp:list-item --></p>
<li>https://www.kaggle.com/artgor</li>
<p><!-- /wp:list-item -->
</ul>
<p><!-- /wp:list --></p>
<p><!-- wp:paragraph --></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:paragraph --></p>
<p><!-- /wp:paragraph --></p>
<p><!-- wp:html --><br />
<main></p>
<div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">'''</span>
<span class="s1">Kaggle Competiontin:</span><span class="se">\n\t</span><span class="s1"> https://www.kaggle.com/c/microsoft-malware-prediction</span><span class="se">\n</span>

<span class="s1">Format:</span><span class="se">\t</span><span class="s1"> Playground</span>
<span class="s1">Code used : 1) https://www.kaggle.com/bogorodvo</span><span class="se">\n</span>
<span class="s1">            2) https://www.kaggle.com/artgor</span><span class="se">\n</span>

<span class="s1">'''</span><span class="p">)</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Kaggle Competiontin:
	 https://www.kaggle.com/c/microsoft-malware-prediction


Format:	 Playground
Code used : 1) https://www.kaggle.com/bogorodvo

            2) https://www.kaggle.com/artgor



</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3">
<pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">LabelEncoder</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">vstack</span><span class="p">,</span> <span class="n">csr_matrix</span><span class="p">,</span> <span class="n">save_npz</span><span class="p">,</span> <span class="n">load_npz</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">xgboost</span> <span class="k">as</span> <span class="nn">xgb</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">time</span>


<span class="kn">from</span> <span class="nn">XGBoost.XGBoostOptimizer</span> <span class="kn">import</span> <span class="n">XGBoostOptimizer</span>
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3">
<pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">'ggplot'</span><span class="p">)</span>
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3">
<pre><span></span><span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">'ignore'</span><span class="p">)</span>
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3">
<pre><span></span><span class="n">gc</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>
<span class="n">path_to_train</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'nogit/path-to-data.txt'</span><span class="p">,</span><span class="s1">'r'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="o">+</span><span class="s1">'train.csv'</span>
<span class="n">path_to_test</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'nogit/path-to-data.txt'</span><span class="p">,</span><span class="s1">'r'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="o">+</span><span class="s1">'test.csv'</span>

<span class="n">dtypes</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'MachineIdentifier'</span><span class="p">:</span>                                    <span class="s1">'category'</span><span class="p">,</span>
        <span class="s1">'ProductName'</span><span class="p">:</span>                                          <span class="s1">'category'</span><span class="p">,</span>
        <span class="s1">'EngineVersion'</span><span class="p">:</span>                                        <span class="s1">'category'</span><span class="p">,</span>
        <span class="s1">'AppVersion'</span><span class="p">:</span>                                           <span class="s1">'category'</span><span class="p">,</span>
        <span class="s1">'AvSigVersion'</span><span class="p">:</span>                                         <span class="s1">'category'</span><span class="p">,</span>
        <span class="s1">'IsBeta'</span><span class="p">:</span>                                               <span class="s1">'int8'</span><span class="p">,</span>
        <span class="s1">'RtpStateBitfield'</span><span class="p">:</span>                                     <span class="s1">'float16'</span><span class="p">,</span>
        <span class="s1">'IsSxsPassiveMode'</span><span class="p">:</span>                                     <span class="s1">'int8'</span><span class="p">,</span>
        <span class="s1">'DefaultBrowsersIdentifier'</span><span class="p">:</span>                            <span class="s1">'float32'</span><span class="p">,</span>
        <span class="s1">'AVProductStatesIdentifier'</span><span class="p">:</span>                            <span class="s1">'float32'</span><span class="p">,</span>
        <span class="s1">'AVProductsInstalled'</span><span class="p">:</span>                                  <span class="s1">'float16'</span><span class="p">,</span>
        <span class="s1">'AVProductsEnabled'</span><span class="p">:</span>                                    <span class="s1">'float16'</span><span class="p">,</span>
        <span class="s1">'HasTpm'</span><span class="p">:</span>                                               <span class="s1">'int8'</span><span class="p">,</span>
        <span class="s1">'CountryIdentifier'</span><span class="p">:</span>                                    <span class="s1">'int16'</span><span class="p">,</span>
        <span class="s1">'CityIdentifier'</span><span class="p">:</span>                                       <span class="s1">'float32'</span><span class="p">,</span>
        <span class="s1">'OrganizationIdentifier'</span><span class="p">:</span>                               <span class="s1">'float16'</span><span class="p">,</span>
        <span class="s1">'GeoNameIdentifier'</span><span class="p">:</span>                                    <span class="s1">'float16'</span><span class="p">,</span>
        <span class="s1">'LocaleEnglishNameIdentifier'</span><span class="p">:</span>                          <span class="s1">'int16'</span><span class="p">,</span>
        <span class="s1">'Platform'</span><span class="p">:</span>                                             <span class="s1">'category'</span><span class="p">,</span>
        <span class="s1">'Processor'</span><span class="p">:</span>                                            <span class="s1">'category'</span><span class="p">,</span>
        <span class="s1">'OsVer'</span><span class="p">:</span>                                                <span class="s1">'category'</span><span class="p">,</span>
        <span class="s1">'OsBuild'</span><span class="p">:</span>                                              <span class="s1">'int16'</span><span class="p">,</span>
        <span class="s1">'OsSuite'</span><span class="p">:</span>                                              <span class="s1">'int16'</span><span class="p">,</span>
        <span class="s1">'OsPlatformSubRelease'</span><span class="p">:</span>                                 <span class="s1">'category'</span><span class="p">,</span>
        <span class="s1">'OsBuildLab'</span><span class="p">:</span>                                           <span class="s1">'category'</span><span class="p">,</span>
        <span class="s1">'SkuEdition'</span><span class="p">:</span>                                           <span class="s1">'category'</span><span class="p">,</span>
        <span class="s1">'IsProtected'</span><span class="p">:</span>                                          <span class="s1">'float16'</span><span class="p">,</span>
        <span class="s1">'AutoSampleOptIn'</span><span class="p">:</span>                                      <span class="s1">'int8'</span><span class="p">,</span>
        <span class="s1">'PuaMode'</span><span class="p">:</span>                                              <span class="s1">'category'</span><span class="p">,</span>
        <span class="s1">'SMode'</span><span class="p">:</span>                                                <span class="s1">'float16'</span><span class="p">,</span>
        <span class="s1">'IeVerIdentifier'</span><span class="p">:</span>                                      <span class="s1">'float16'</span><span class="p">,</span>
        <span class="s1">'SmartScreen'</span><span class="p">:</span>                                          <span class="s1">'category'</span><span class="p">,</span>
        <span class="s1">'Firewall'</span><span class="p">:</span>                                             <span class="s1">'float16'</span><span class="p">,</span>
        <span class="s1">'UacLuaenable'</span><span class="p">:</span>                                         <span class="s1">'float64'</span><span class="p">,</span> <span class="c1"># was 'float32'</span>
        <span class="s1">'Census_MDC2FormFactor'</span><span class="p">:</span>                                <span class="s1">'category'</span><span class="p">,</span>
        <span class="s1">'Census_DeviceFamily'</span><span class="p">:</span>                                  <span class="s1">'category'</span><span class="p">,</span>
        <span class="s1">'Census_OEMNameIdentifier'</span><span class="p">:</span>                             <span class="s1">'float32'</span><span class="p">,</span> <span class="c1"># was 'float16'</span>
        <span class="s1">'Census_OEMModelIdentifier'</span><span class="p">:</span>                            <span class="s1">'float32'</span><span class="p">,</span>
        <span class="s1">'Census_ProcessorCoreCount'</span><span class="p">:</span>                            <span class="s1">'float16'</span><span class="p">,</span>
        <span class="s1">'Census_ProcessorManufacturerIdentifier'</span><span class="p">:</span>               <span class="s1">'float16'</span><span class="p">,</span>
        <span class="s1">'Census_ProcessorModelIdentifier'</span><span class="p">:</span>                      <span class="s1">'float32'</span><span class="p">,</span> <span class="c1"># was 'float16'</span>
        <span class="s1">'Census_ProcessorClass'</span><span class="p">:</span>                                <span class="s1">'category'</span><span class="p">,</span>
        <span class="s1">'Census_PrimaryDiskTotalCapacity'</span><span class="p">:</span>                      <span class="s1">'float64'</span><span class="p">,</span> <span class="c1"># was 'float32'</span>
        <span class="s1">'Census_PrimaryDiskTypeName'</span><span class="p">:</span>                           <span class="s1">'category'</span><span class="p">,</span>
        <span class="s1">'Census_SystemVolumeTotalCapacity'</span><span class="p">:</span>                     <span class="s1">'float64'</span><span class="p">,</span> <span class="c1"># was 'float32'</span>
        <span class="s1">'Census_HasOpticalDiskDrive'</span><span class="p">:</span>                           <span class="s1">'int8'</span><span class="p">,</span>
        <span class="s1">'Census_TotalPhysicalRAM'</span><span class="p">:</span>                              <span class="s1">'float32'</span><span class="p">,</span>
        <span class="s1">'Census_ChassisTypeName'</span><span class="p">:</span>                               <span class="s1">'category'</span><span class="p">,</span>
        <span class="s1">'Census_InternalPrimaryDiagonalDisplaySizeInInches'</span><span class="p">:</span>    <span class="s1">'float32'</span><span class="p">,</span> <span class="c1"># was 'float16'</span>
        <span class="s1">'Census_InternalPrimaryDisplayResolutionHorizontal'</span><span class="p">:</span>    <span class="s1">'float32'</span><span class="p">,</span> <span class="c1"># was 'float16'</span>
        <span class="s1">'Census_InternalPrimaryDisplayResolutionVertical'</span><span class="p">:</span>      <span class="s1">'float32'</span><span class="p">,</span> <span class="c1"># was 'float16'</span>
        <span class="s1">'Census_PowerPlatformRoleName'</span><span class="p">:</span>                         <span class="s1">'category'</span><span class="p">,</span>
        <span class="s1">'Census_InternalBatteryType'</span><span class="p">:</span>                           <span class="s1">'category'</span><span class="p">,</span>
        <span class="s1">'Census_InternalBatteryNumberOfCharges'</span><span class="p">:</span>                <span class="s1">'float64'</span><span class="p">,</span> <span class="c1"># was 'float32'</span>
        <span class="s1">'Census_OSVersion'</span><span class="p">:</span>                                     <span class="s1">'category'</span><span class="p">,</span>
        <span class="s1">'Census_OSArchitecture'</span><span class="p">:</span>                                <span class="s1">'category'</span><span class="p">,</span>
        <span class="s1">'Census_OSBranch'</span><span class="p">:</span>                                      <span class="s1">'category'</span><span class="p">,</span>
        <span class="s1">'Census_OSBuildNumber'</span><span class="p">:</span>                                 <span class="s1">'int16'</span><span class="p">,</span>
        <span class="s1">'Census_OSBuildRevision'</span><span class="p">:</span>                               <span class="s1">'int32'</span><span class="p">,</span>
        <span class="s1">'Census_OSEdition'</span><span class="p">:</span>                                     <span class="s1">'category'</span><span class="p">,</span>
        <span class="s1">'Census_OSSkuName'</span><span class="p">:</span>                                     <span class="s1">'category'</span><span class="p">,</span>
        <span class="s1">'Census_OSInstallTypeName'</span><span class="p">:</span>                             <span class="s1">'category'</span><span class="p">,</span>
        <span class="s1">'Census_OSInstallLanguageIdentifier'</span><span class="p">:</span>                   <span class="s1">'float16'</span><span class="p">,</span>
        <span class="s1">'Census_OSUILocaleIdentifier'</span><span class="p">:</span>                          <span class="s1">'int16'</span><span class="p">,</span>
        <span class="s1">'Census_OSWUAutoUpdateOptionsName'</span><span class="p">:</span>                     <span class="s1">'category'</span><span class="p">,</span>
        <span class="s1">'Census_IsPortableOperatingSystem'</span><span class="p">:</span>                     <span class="s1">'int8'</span><span class="p">,</span>
        <span class="s1">'Census_GenuineStateName'</span><span class="p">:</span>                              <span class="s1">'category'</span><span class="p">,</span>
        <span class="s1">'Census_ActivationChannel'</span><span class="p">:</span>                             <span class="s1">'category'</span><span class="p">,</span>
        <span class="s1">'Census_IsFlightingInternal'</span><span class="p">:</span>                           <span class="s1">'float16'</span><span class="p">,</span>
        <span class="s1">'Census_IsFlightsDisabled'</span><span class="p">:</span>                             <span class="s1">'float16'</span><span class="p">,</span>
        <span class="s1">'Census_FlightRing'</span><span class="p">:</span>                                    <span class="s1">'category'</span><span class="p">,</span>
        <span class="s1">'Census_ThresholdOptIn'</span><span class="p">:</span>                                <span class="s1">'float16'</span><span class="p">,</span>
        <span class="s1">'Census_FirmwareManufacturerIdentifier'</span><span class="p">:</span>                <span class="s1">'float16'</span><span class="p">,</span>
        <span class="s1">'Census_FirmwareVersionIdentifier'</span><span class="p">:</span>                     <span class="s1">'float32'</span><span class="p">,</span>
        <span class="s1">'Census_IsSecureBootEnabled'</span><span class="p">:</span>                           <span class="s1">'int8'</span><span class="p">,</span>
        <span class="s1">'Census_IsWIMBootEnabled'</span><span class="p">:</span>                              <span class="s1">'float16'</span><span class="p">,</span>
        <span class="s1">'Census_IsVirtualDevice'</span><span class="p">:</span>                               <span class="s1">'float16'</span><span class="p">,</span>
        <span class="s1">'Census_IsTouchEnabled'</span><span class="p">:</span>                                <span class="s1">'int8'</span><span class="p">,</span>
        <span class="s1">'Census_IsPenCapable'</span><span class="p">:</span>                                  <span class="s1">'int8'</span><span class="p">,</span>
        <span class="s1">'Census_IsAlwaysOnAlwaysConnectedCapable'</span><span class="p">:</span>              <span class="s1">'float16'</span><span class="p">,</span>
        <span class="s1">'Wdft_IsGamer'</span><span class="p">:</span>                                         <span class="s1">'float16'</span><span class="p">,</span>
        <span class="s1">'Wdft_RegionIdentifier'</span><span class="p">:</span>                                <span class="s1">'float16'</span><span class="p">,</span>
        <span class="s1">'HasDetections'</span><span class="p">:</span>                                        <span class="s1">'int8'</span>
        <span class="p">}</span>



<span class="k">def</span> <span class="nf">get_df_stats</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">stats</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">col</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">(),</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>

    <span class="n">stats_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">'Feature'</span><span class="p">,</span> <span class="s1">'Unique_values'</span><span class="p">,</span> <span class="s1">'Percentage of missing values'</span><span class="p">,</span> <span class="s1">'Percentage of values in the biggest category'</span><span class="p">,</span> <span class="s1">'dtype'</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">stats_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">'Percentage of missing values'</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3">
<pre><span></span><span class="c1">#read data sample</span>
<span class="n">nrows</span> <span class="o">=</span> <span class="mi">50000</span>
<span class="n">df_train_samp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_to_train</span>
                            <span class="p">,</span><span class="n">nrows</span><span class="o">=</span> <span class="n">nrows</span>
                            <span class="c1">#,skiprows=lambda x: x&gt;0 and random.random()&gt; p</span>
                            <span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtypes</span><span class="p">)</span>
<span class="n">df_train_samp</span><span class="p">[</span><span class="s1">'MachineIdentifier'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_train_samp</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'uint32'</span><span class="p">)</span>
<span class="n">df_test_samp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_to_test</span>
                            <span class="p">,</span><span class="n">nrows</span><span class="o">=</span> <span class="n">nrows</span>
                            <span class="c1">#,skiprows=lambda x: x&gt;0 and random.random()&gt; p</span>
                           <span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtypes</span><span class="p">)</span>
<span class="n">df_test_samp</span><span class="p">[</span><span class="s1">'MachineIdentifier'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_test_samp</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'uint32'</span><span class="p">)</span>
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3">
<pre><span></span><span class="n">df_train_samp</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child jp-OutputArea-executeResult">
<div class="jp-OutputPrompt jp-OutputArea-prompt">Out[ ]:</div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output jp-OutputArea-executeResult" data-mime-type="text/html" tabindex="0">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {<br />
        vertical-align: middle;<br />
    }</p>
<p>    .dataframe tbody tr th {<br />
        vertical-align: top;<br />
    }</p>
<p>    .dataframe thead th {<br />
        text-align: right;<br />
    }<br />
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>MachineIdentifier</th>
<th>ProductName</th>
<th>EngineVersion</th>
<th>AppVersion</th>
<th>AvSigVersion</th>
<th>IsBeta</th>
<th>RtpStateBitfield</th>
<th>IsSxsPassiveMode</th>
<th>DefaultBrowsersIdentifier</th>
<th>AVProductStatesIdentifier</th>
<th>...</th>
<th>Census_FirmwareVersionIdentifier</th>
<th>Census_IsSecureBootEnabled</th>
<th>Census_IsWIMBootEnabled</th>
<th>Census_IsVirtualDevice</th>
<th>Census_IsTouchEnabled</th>
<th>Census_IsPenCapable</th>
<th>Census_IsAlwaysOnAlwaysConnectedCapable</th>
<th>Wdft_IsGamer</th>
<th>Wdft_RegionIdentifier</th>
<th>HasDetections</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>0</td>
<td>win8defender</td>
<td>1.1.15100.1</td>
<td>4.18.1807.18075</td>
<td>1.273.1735.0</td>
<td>0</td>
<td>7.0</td>
<td>0</td>
<td>NaN</td>
<td>53447.0</td>
<td>...</td>
<td>36144.0</td>
<td>0</td>
<td>NaN</td>
<td>0.0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>10.0</td>
<td>0</td>
</tr>
<tr>
<th>1</th>
<td>1</td>
<td>win8defender</td>
<td>1.1.14600.4</td>
<td>4.13.17134.1</td>
<td>1.263.48.0</td>
<td>0</td>
<td>7.0</td>
<td>0</td>
<td>NaN</td>
<td>53447.0</td>
<td>...</td>
<td>57858.0</td>
<td>0</td>
<td>NaN</td>
<td>0.0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>8.0</td>
<td>0</td>
</tr>
<tr>
<th>2</th>
<td>2</td>
<td>win8defender</td>
<td>1.1.15100.1</td>
<td>4.18.1807.18075</td>
<td>1.273.1341.0</td>
<td>0</td>
<td>7.0</td>
<td>0</td>
<td>NaN</td>
<td>53447.0</td>
<td>...</td>
<td>52682.0</td>
<td>0</td>
<td>NaN</td>
<td>0.0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>3.0</td>
<td>0</td>
</tr>
<tr>
<th>3</th>
<td>3</td>
<td>win8defender</td>
<td>1.1.15100.1</td>
<td>4.18.1807.18075</td>
<td>1.273.1527.0</td>
<td>0</td>
<td>7.0</td>
<td>0</td>
<td>NaN</td>
<td>53447.0</td>
<td>...</td>
<td>20050.0</td>
<td>0</td>
<td>NaN</td>
<td>0.0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>3.0</td>
<td>1</td>
</tr>
<tr>
<th>4</th>
<td>4</td>
<td>win8defender</td>
<td>1.1.15100.1</td>
<td>4.18.1807.18075</td>
<td>1.273.1379.0</td>
<td>0</td>
<td>7.0</td>
<td>0</td>
<td>NaN</td>
<td>53447.0</td>
<td>...</td>
<td>19844.0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>1.0</td>
<td>1</td>
</tr>
</tbody>
</table>
<p>5 rows × 83 columns</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">'Train DF shape: '</span>
      <span class="p">,</span> <span class="n">df_train_samp</span><span class="o">.</span><span class="n">shape</span>
      <span class="p">,</span><span class="s1">'</span><span class="se">\n</span><span class="s1">Test DF shape: '</span>
      <span class="p">,</span> <span class="n">df_test_samp</span><span class="o">.</span><span class="n">shape</span>
      <span class="p">,</span><span class="s1">'</span><span class="se">\n</span><span class="s1">DF size:'</span>
      <span class="p">,</span><span class="nb">round</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">df_train_samp</span><span class="o">.</span><span class="n">memory_usage</span><span class="p">())</span><span class="o">/</span><span class="mi">1024</span><span class="o">/</span><span class="mi">1024</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
      <span class="p">,</span><span class="s1">'Mb</span><span class="se">\n</span><span class="s1">'</span><span class="c1">#Estimated full df size =', df_train_samp.shape[0]/p, 'rows.'</span>
     <span class="p">)</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Train DF shape:  (50000, 83) 
Test DF shape:  (50000, 82) 
DF size: 8.91 Mb

</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3">
<pre><span></span><span class="c1"># Examine df columns. We see a bunch of fields with a lot of empty values. </span>
<span class="c1"># It's better to exclude these columns from the model</span>
<span class="n">df_stats</span><span class="o">=</span> <span class="n">get_df_stats</span><span class="p">(</span><span class="n">df_train_samp</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">'Percentage of missing values'</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">df_stats</span><span class="o">.</span><span class="n">to_html</span><span class="p">(</span><span class="s1">'features.html'</span><span class="p">)</span>
<span class="n">df_stats</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">df_stats</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="c1">#df_stats.head(15)</span>
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3">
<pre><span></span><span class="c1">#Feature Engineering Stage </span>
<span class="c1">#Let's figure out the most important variables</span>
<span class="c1">#1 - We'll exclude all missing features with &gt;90% missing variables</span>
<span class="n">df_stats</span> <span class="o">=</span> <span class="n">df_stats</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_stats</span><span class="p">[</span><span class="s1">'Percentage of missing values'</span><span class="p">]</span> <span class="o">&lt;</span><span class="mf">0.9</span><span class="p">]</span>
<span class="n">good_columns</span> <span class="o">=</span><span class="n">df_stats</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_stats</span><span class="p">[</span><span class="s1">'Percentage of missing values'</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">0.9</span><span class="p">]</span><span class="o">.</span><span class="n">Feature</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'Useable columns remains:'</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">good_columns</span><span class="p">))</span>
<span class="n">good_columns_dtype</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">good_columns</span><span class="p">}</span>
<span class="n">df_train_samp</span> <span class="o">=</span> <span class="n">df_train_samp</span><span class="p">[</span><span class="n">good_columns</span><span class="p">]</span>
<span class="n">df_test_samp</span> <span class="o">=</span> <span class="n">df_test_samp</span><span class="p">[</span><span class="n">good_columns</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Useable columns remains: 62
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3">
<pre><span></span><span class="c1">#Lets count a number of variables by feature category</span>
<span class="c1">#df contains 26 categorical and 37 numerical variables</span>
<span class="n">df_stats</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">"dtype"</span><span class="p">)[</span><span class="s1">'Feature'</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child jp-OutputArea-executeResult">
<div class="jp-OutputPrompt jp-OutputArea-prompt">Out[ ]:</div>
<div class="jp-RenderedText jp-OutputArea-output jp-OutputArea-executeResult" data-mime-type="text/plain" tabindex="0">
<pre>dtype
category    25
float16     11
float32      5
float64      3
int16        6
int32        1
int8        10
uint64       1
Name: Feature, dtype: int64</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3">
<pre><span></span><span class="c1"># Pring all categorical variables</span>
<span class="c1"># Census_DeviceFamily , ProductName OsVer ,Platform , Census_FlightRing , Census_OSArchitecture and Processor</span>
<span class="c1"># are very unbalanced (more 90% are in the biggest bucket).</span>
<span class="c1"># There's few missing values in the categorical featurs, what is good</span>
<span class="c1"># MachineIdentifier seems to be useless in this analysis </span>
<span class="n">df_stats</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">'dtype=="category"'</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">'Percentage of values in the biggest category'</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child jp-OutputArea-executeResult">
<div class="jp-OutputPrompt jp-OutputArea-prompt">Out[ ]:</div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output jp-OutputArea-executeResult" data-mime-type="text/html" tabindex="0">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {<br />
        vertical-align: middle;<br />
    }</p>
<p>    .dataframe tbody tr th {<br />
        vertical-align: top;<br />
    }</p>
<p>    .dataframe thead th {<br />
        text-align: right;<br />
    }<br />
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>Feature</th>
<th>Unique_values</th>
<th>Percentage of missing values</th>
<th>Percentage of values in the biggest category</th>
<th>dtype</th>
</tr>
</thead>
<tbody>
<tr>
<th>35</th>
<td>Census_DeviceFamily</td>
<td>2</td>
<td>0.000</td>
<td>99.868</td>
<td>category</td>
</tr>
<tr>
<th>1</th>
<td>ProductName</td>
<td>2</td>
<td>0.000</td>
<td>98.876</td>
<td>category</td>
</tr>
<tr>
<th>20</th>
<td>OsVer</td>
<td>8</td>
<td>0.000</td>
<td>96.790</td>
<td>category</td>
</tr>
<tr>
<th>18</th>
<td>Platform</td>
<td>4</td>
<td>0.000</td>
<td>96.662</td>
<td>category</td>
</tr>
<tr>
<th>70</th>
<td>Census_FlightRing</td>
<td>7</td>
<td>0.000</td>
<td>93.602</td>
<td>category</td>
</tr>
<tr>
<th>19</th>
<td>Processor</td>
<td>3</td>
<td>0.000</td>
<td>90.984</td>
<td>category</td>
</tr>
<tr>
<th>55</th>
<td>Census_OSArchitecture</td>
<td>3</td>
<td>0.000</td>
<td>90.978</td>
<td>category</td>
</tr>
<tr>
<th>66</th>
<td>Census_GenuineStateName</td>
<td>4</td>
<td>0.000</td>
<td>88.370</td>
<td>category</td>
</tr>
<tr>
<th>51</th>
<td>Census_PowerPlatformRoleName</td>
<td>8</td>
<td>0.000</td>
<td>69.046</td>
<td>category</td>
</tr>
<tr>
<th>43</th>
<td>Census_PrimaryDiskTypeName</td>
<td>4</td>
<td>0.166</td>
<td>64.682</td>
<td>category</td>
</tr>
<tr>
<th>34</th>
<td>Census_MDC2FormFactor</td>
<td>11</td>
<td>0.000</td>
<td>63.862</td>
<td>category</td>
</tr>
<tr>
<th>25</th>
<td>SkuEdition</td>
<td>8</td>
<td>0.000</td>
<td>61.574</td>
<td>category</td>
</tr>
<tr>
<th>47</th>
<td>Census_ChassisTypeName</td>
<td>26</td>
<td>0.004</td>
<td>58.386</td>
<td>category</td>
</tr>
<tr>
<th>3</th>
<td>AppVersion</td>
<td>74</td>
<td>0.000</td>
<td>58.196</td>
<td>category</td>
</tr>
<tr>
<th>67</th>
<td>Census_ActivationChannel</td>
<td>6</td>
<td>0.000</td>
<td>52.690</td>
<td>category</td>
</tr>
<tr>
<th>56</th>
<td>Census_OSBranch</td>
<td>15</td>
<td>0.000</td>
<td>45.040</td>
<td>category</td>
</tr>
<tr>
<th>64</th>
<td>Census_OSWUAutoUpdateOptionsName</td>
<td>6</td>
<td>0.000</td>
<td>44.070</td>
<td>category</td>
</tr>
<tr>
<th>23</th>
<td>OsPlatformSubRelease</td>
<td>9</td>
<td>0.000</td>
<td>43.920</td>
<td>category</td>
</tr>
<tr>
<th>2</th>
<td>EngineVersion</td>
<td>38</td>
<td>0.000</td>
<td>43.308</td>
<td>category</td>
</tr>
<tr>
<th>24</th>
<td>OsBuildLab</td>
<td>316</td>
<td>0.000</td>
<td>41.098</td>
<td>category</td>
</tr>
<tr>
<th>60</th>
<td>Census_OSSkuName</td>
<td>16</td>
<td>0.000</td>
<td>38.846</td>
<td>category</td>
</tr>
<tr>
<th>59</th>
<td>Census_OSEdition</td>
<td>18</td>
<td>0.000</td>
<td>38.846</td>
<td>category</td>
</tr>
<tr>
<th>61</th>
<td>Census_OSInstallTypeName</td>
<td>9</td>
<td>0.000</td>
<td>29.454</td>
<td>category</td>
</tr>
<tr>
<th>54</th>
<td>Census_OSVersion</td>
<td>241</td>
<td>0.000</td>
<td>15.612</td>
<td>category</td>
</tr>
<tr>
<th>4</th>
<td>AvSigVersion</td>
<td>3105</td>
<td>0.000</td>
<td>1.156</td>
<td>category</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3">
<pre><span></span><span class="n">df_stats</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">'dtype!="category"'</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">'Unique_values'</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child jp-OutputArea-executeResult">
<div class="jp-OutputPrompt jp-OutputArea-prompt">Out[ ]:</div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output jp-OutputArea-executeResult" data-mime-type="text/html" tabindex="0">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {<br />
        vertical-align: middle;<br />
    }</p>
<p>    .dataframe tbody tr th {<br />
        vertical-align: top;<br />
    }</p>
<p>    .dataframe thead th {<br />
        text-align: right;<br />
    }<br />
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>Feature</th>
<th>Unique_values</th>
<th>Percentage of missing values</th>
<th>Percentage of values in the biggest category</th>
<th>dtype</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>MachineIdentifier</td>
<td>50000</td>
<td>0.000</td>
<td>0.002</td>
<td>uint64</td>
</tr>
<tr>
<th>44</th>
<td>Census_SystemVolumeTotalCapacity</td>
<td>26255</td>
<td>0.628</td>
<td>0.628</td>
<td>float64</td>
</tr>
<tr>
<th>40</th>
<td>Census_ProcessorModelIdentifier</td>
<td>1509</td>
<td>0.482</td>
<td>3.220</td>
<td>float32</td>
</tr>
<tr>
<th>9</th>
<td>AVProductStatesIdentifier</td>
<td>1367</td>
<td>0.382</td>
<td>65.532</td>
<td>float32</td>
</tr>
<tr>
<th>42</th>
<td>Census_PrimaryDiskTotalCapacity</td>
<td>318</td>
<td>0.628</td>
<td>31.506</td>
<td>float64</td>
</tr>
<tr>
<th>48</th>
<td>Census_InternalPrimaryDiagonalDisplaySizeInInches</td>
<td>304</td>
<td>0.540</td>
<td>33.980</td>
<td>float32</td>
</tr>
<tr>
<th>16</th>
<td>GeoNameIdentifier</td>
<td>226</td>
<td>0.002</td>
<td>17.196</td>
<td>float16</td>
</tr>
<tr>
<th>13</th>
<td>CountryIdentifier</td>
<td>216</td>
<td>0.000</td>
<td>4.454</td>
<td>int16</td>
</tr>
<tr>
<th>58</th>
<td>Census_OSBuildRevision</td>
<td>209</td>
<td>0.000</td>
<td>15.614</td>
<td>int32</td>
</tr>
<tr>
<th>17</th>
<td>LocaleEnglishNameIdentifier</td>
<td>171</td>
<td>0.000</td>
<td>23.304</td>
<td>int16</td>
</tr>
<tr>
<th>30</th>
<td>IeVerIdentifier</td>
<td>132</td>
<td>0.666</td>
<td>43.558</td>
<td>float16</td>
</tr>
<tr>
<th>50</th>
<td>Census_InternalPrimaryDisplayResolutionVertical</td>
<td>118</td>
<td>0.540</td>
<td>55.452</td>
<td>float32</td>
</tr>
<tr>
<th>49</th>
<td>Census_InternalPrimaryDisplayResolutionHorizontal</td>
<td>107</td>
<td>0.540</td>
<td>50.270</td>
<td>float32</td>
</tr>
<tr>
<th>63</th>
<td>Census_OSUILocaleIdentifier</td>
<td>55</td>
<td>0.000</td>
<td>35.542</td>
<td>int16</td>
</tr>
<tr>
<th>62</th>
<td>Census_OSInstallLanguageIdentifier</td>
<td>39</td>
<td>0.710</td>
<td>35.602</td>
<td>float16</td>
</tr>
<tr>
<th>21</th>
<td>OsBuild</td>
<td>33</td>
<td>0.000</td>
<td>43.920</td>
<td>int16</td>
</tr>
<tr>
<th>57</th>
<td>Census_OSBuildNumber</td>
<td>31</td>
<td>0.000</td>
<td>45.032</td>
<td>int16</td>
</tr>
<tr>
<th>38</th>
<td>Census_ProcessorCoreCount</td>
<td>13</td>
<td>0.480</td>
<td>60.854</td>
<td>float16</td>
</tr>
<tr>
<th>22</th>
<td>OsSuite</td>
<td>7</td>
<td>0.000</td>
<td>62.132</td>
<td>int16</td>
</tr>
<tr>
<th>6</th>
<td>RtpStateBitfield</td>
<td>6</td>
<td>0.350</td>
<td>97.002</td>
<td>float16</td>
</tr>
<tr>
<th>10</th>
<td>AVProductsInstalled</td>
<td>5</td>
<td>0.382</td>
<td>69.886</td>
<td>float16</td>
</tr>
<tr>
<th>11</th>
<td>AVProductsEnabled</td>
<td>5</td>
<td>0.382</td>
<td>97.108</td>
<td>float16</td>
</tr>
<tr>
<th>33</th>
<td>UacLuaenable</td>
<td>3</td>
<td>0.116</td>
<td>99.246</td>
<td>float64</td>
</tr>
<tr>
<th>39</th>
<td>Census_ProcessorManufacturerIdentifier</td>
<td>3</td>
<td>0.480</td>
<td>87.734</td>
<td>float16</td>
</tr>
<tr>
<th>74</th>
<td>Census_IsSecureBootEnabled</td>
<td>2</td>
<td>0.000</td>
<td>51.606</td>
<td>int8</td>
</tr>
<tr>
<th>77</th>
<td>Census_IsTouchEnabled</td>
<td>2</td>
<td>0.000</td>
<td>87.370</td>
<td>int8</td>
</tr>
<tr>
<th>65</th>
<td>Census_IsPortableOperatingSystem</td>
<td>2</td>
<td>0.000</td>
<td>99.920</td>
<td>int8</td>
</tr>
<tr>
<th>78</th>
<td>Census_IsPenCapable</td>
<td>2</td>
<td>0.000</td>
<td>96.244</td>
<td>int8</td>
</tr>
<tr>
<th>79</th>
<td>Census_IsAlwaysOnAlwaysConnectedCapable</td>
<td>2</td>
<td>0.880</td>
<td>93.372</td>
<td>float16</td>
</tr>
<tr>
<th>12</th>
<td>HasTpm</td>
<td>2</td>
<td>0.000</td>
<td>98.736</td>
<td>int8</td>
</tr>
<tr>
<th>45</th>
<td>Census_HasOpticalDiskDrive</td>
<td>2</td>
<td>0.000</td>
<td>92.414</td>
<td>int8</td>
</tr>
<tr>
<th>7</th>
<td>IsSxsPassiveMode</td>
<td>2</td>
<td>0.000</td>
<td>98.234</td>
<td>int8</td>
</tr>
<tr>
<th>76</th>
<td>Census_IsVirtualDevice</td>
<td>2</td>
<td>0.152</td>
<td>99.174</td>
<td>float16</td>
</tr>
<tr>
<th>26</th>
<td>IsProtected</td>
<td>2</td>
<td>0.380</td>
<td>94.284</td>
<td>float16</td>
</tr>
<tr>
<th>82</th>
<td>HasDetections</td>
<td>2</td>
<td>0.000</td>
<td>50.122</td>
<td>int8</td>
</tr>
<tr>
<th>5</th>
<td>IsBeta</td>
<td>1</td>
<td>0.000</td>
<td>100.000</td>
<td>int8</td>
</tr>
<tr>
<th>27</th>
<td>AutoSampleOptIn</td>
<td>1</td>
<td>0.000</td>
<td>100.000</td>
<td>int8</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3">
<pre><span></span><span class="c1">#Check cluster balance - A distribution seems to be equal</span>
<span class="n">df_train_samp</span><span class="p">[</span><span class="s1">'HasDetections'</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bar</span><span class="p">()</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child jp-OutputArea-executeResult">
<div class="jp-OutputPrompt jp-OutputArea-prompt">Out[ ]:</div>
<div class="jp-RenderedText jp-OutputArea-output jp-OutputArea-executeResult" data-mime-type="text/plain" tabindex="0">
<pre>&lt;matplotlib.axes._subplots.AxesSubplot at 0x7fa11384b278&gt;</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<figure><img alt="No description has been provided for this image" class="" src="{{site.baseurl}}/assets/2019/05/RKNRZsyYUe4xhO9WkiT1wtdqkqSAcZAkBYyDJClgHCRJgf8DOAHlAkgVv3AAAAAASUVORK5CYII="></figure>
<div class="jp-RenderedImage jp-OutputArea-output" tabindex="0">
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3">
<pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">catplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"Census_PrimaryDiskTypeName"</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">"HasDetections"</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s2">"Census_MDC2FormFactor"</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">df_train_samp</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">"count"</span><span class="p">,</span><span class="n">col_wrap</span><span class="o">=</span><span class="mi">3</span><span class="p">);</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<figure><img alt="No description has been provided for this image" class="" src="{{site.baseurl}}/assets/2019/05/RUAANzomJoHAAAAAAAAQzA1DwAAAAAAAIYgiAIAAAAAAIAhCKIAAAAAAABgCIIoAAAAAAAAGIIgCgAAAAAAAIb4f8QllXGXp0sQAAAAAElFTkSuQmCC"></figure>
<div class="jp-RenderedImage jp-OutputArea-output" tabindex="0">
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3">
<pre><span></span><span class="n">labeldict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">LabelEncoder</span><span class="p">)</span>

<span class="n">y_train_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_train_samp</span><span class="p">[</span><span class="s1">'HasDetections'</span><span class="p">])</span>
<span class="n">train_ids</span> <span class="o">=</span> <span class="n">df_train_samp</span><span class="o">.</span><span class="n">index</span>
<span class="n">test_ids</span>  <span class="o">=</span> <span class="n">df_train_samp</span><span class="o">.</span><span class="n">index</span>
<span class="k">del</span> <span class="n">df_train_samp</span><span class="p">[</span><span class="s1">'HasDetections'</span><span class="p">],</span> <span class="n">df_train_samp</span><span class="p">[</span><span class="s1">'MachineIdentifier'</span><span class="p">],</span> <span class="n">df_test_samp</span><span class="p">[</span><span class="s1">'MachineIdentifier'</span><span class="p">]</span>



<span class="n">df_train_samp_str</span> <span class="o">=</span> <span class="n">df_train_samp</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="n">df_test_samp_str</span> <span class="o">=</span> <span class="n">df_test_samp</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

<span class="n">full_df</span> <span class="o">=</span> <span class="n">df_train_samp_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_test_samp_str</span><span class="p">,</span><span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">full_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">labeldict</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<span class="n">train_t</span> <span class="o">=</span> <span class="n">df_train_samp_str</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">labeldict</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="n">test_t</span><span class="o">=</span> <span class="n">df_test_samp_str</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">labeldict</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child jp-OutputArea-executeResult">
<div class="jp-OutputPrompt jp-OutputArea-prompt">Out[ ]:</div>
<div class="jp-RenderedText jp-OutputArea-output jp-OutputArea-executeResult" data-mime-type="text/plain" tabindex="0">
<pre>28039</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3">
<pre><span></span><span class="k">def</span> <span class="nf">df_to_category</span><span class="p">(</span><span class="n">train</span><span class="p">,</span><span class="n">test</span><span class="p">,</span><span class="n">min_observations</span><span class="p">,</span><span class="n">unbalanced_bound</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'Transform all features to category.</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">usecol</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">usecol</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'HasDetections'</span><span class="p">,</span><span class="s1">'MachineIdentifier'</span><span class="p">]:</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">train</span><span class="p">[</span><span class="n">usecol</span><span class="p">]</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="n">usecol</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'str'</span><span class="p">)</span>
            <span class="n">test</span><span class="p">[</span><span class="n">usecol</span><span class="p">]</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="n">usecol</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'str'</span><span class="p">)</span>

            <span class="c1">#Fit LabelEncoder</span>
            <span class="n">le</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="n">usecol</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="o">+</span>
                              <span class="n">test</span><span class="p">[</span><span class="n">usecol</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>

            <span class="c1">#At the end 0 will be used for dropped values</span>
            <span class="n">train</span><span class="p">[</span><span class="n">usecol</span><span class="p">]</span> <span class="o">=</span> <span class="n">le</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="n">usecol</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">test</span><span class="p">[</span><span class="n">usecol</span><span class="p">]</span>  <span class="o">=</span> <span class="n">le</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="n">usecol</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>

            <span class="n">agg</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">((</span><span class="n">train</span>
                      <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">usecol</span><span class="p">])</span>
                      <span class="o">.</span><span class="n">aggregate</span><span class="p">({</span><span class="s1">'MachineIdentifier'</span><span class="p">:</span><span class="s1">'count'</span><span class="p">})</span>
                      <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                      <span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">'MachineIdentifier'</span><span class="p">:</span><span class="s1">'train'</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
                        <span class="p">,(</span><span class="n">test</span>
                      <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">usecol</span><span class="p">])</span>
                      <span class="o">.</span><span class="n">aggregate</span><span class="p">({</span><span class="s1">'MachineIdentifier'</span><span class="p">:</span><span class="s1">'count'</span><span class="p">})</span>
                      <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                      <span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">'MachineIdentifier'</span><span class="p">:</span><span class="s1">'test'</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
                           <span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">usecol</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">'outer'</span><span class="p">)</span>
                   <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                  <span class="p">)</span>
            <span class="c1">#Select values with more than 1000 observations</span>
            <span class="n">agg</span> <span class="o">=</span> <span class="n">agg</span><span class="p">[(</span><span class="n">agg</span><span class="p">[</span><span class="s1">'train'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">min_observations</span><span class="p">)]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">agg</span><span class="p">[</span><span class="s1">'Total'</span><span class="p">]</span> <span class="o">=</span> <span class="n">agg</span><span class="p">[</span><span class="s1">'train'</span><span class="p">]</span> <span class="o">+</span> <span class="n">agg</span><span class="p">[</span><span class="s1">'test'</span><span class="p">]</span>
            <span class="c1">#Drop unbalanced values</span>
            <span class="n">agg</span> <span class="o">=</span> <span class="n">agg</span><span class="p">[(</span><span class="n">agg</span><span class="p">[</span><span class="s1">'train'</span><span class="p">]</span> <span class="o">/</span> <span class="n">agg</span><span class="p">[</span><span class="s1">'Total'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">unbalanced_bound</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">agg</span><span class="p">[</span><span class="s1">'train'</span><span class="p">]</span> <span class="o">/</span> <span class="n">agg</span><span class="p">[</span><span class="s1">'Total'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">unbalanced_bound</span><span class="p">))]</span>
            <span class="n">agg</span><span class="p">[</span><span class="n">usecol</span><span class="o">+</span><span class="s1">'Copy'</span><span class="p">]</span> <span class="o">=</span> <span class="n">agg</span><span class="p">[</span><span class="n">usecol</span><span class="p">]</span>

            <span class="n">train</span><span class="p">[</span><span class="n">usecol</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">train</span><span class="p">[[</span><span class="n">usecol</span><span class="p">]],</span> 
                                      <span class="n">agg</span><span class="p">[[</span><span class="n">usecol</span><span class="p">,</span> <span class="n">usecol</span><span class="o">+</span><span class="s1">'Copy'</span><span class="p">]],</span> 
                                      <span class="n">on</span><span class="o">=</span><span class="n">usecol</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">'left'</span><span class="p">)[</span><span class="n">usecol</span><span class="o">+</span><span class="s1">'Copy'</span><span class="p">]</span>
                             <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'int'</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'category'</span><span class="p">))</span>

            <span class="n">test</span><span class="p">[</span><span class="n">usecol</span><span class="p">]</span>  <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">test</span><span class="p">[[</span><span class="n">usecol</span><span class="p">]],</span> 
                                      <span class="n">agg</span><span class="p">[[</span><span class="n">usecol</span><span class="p">,</span> <span class="n">usecol</span><span class="o">+</span><span class="s1">'Copy'</span><span class="p">]],</span> 
                                      <span class="n">on</span><span class="o">=</span><span class="n">usecol</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">'left'</span><span class="p">)[</span><span class="n">usecol</span><span class="o">+</span><span class="s1">'Copy'</span><span class="p">]</span>
                             <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'int'</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'category'</span><span class="p">))</span>

            <span class="k">del</span> <span class="n">le</span><span class="p">,</span> <span class="n">agg</span><span class="p">,</span> <span class="n">usecol</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">train</span> <span class="p">,</span> <span class="n">test</span>
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3">
<pre><span></span><span class="c1"># train,test =  df_to_category(train = df_train_samp.iloc[:10000]</span>
<span class="c1">#                              ,test = df_test_samp.iloc[:10000]</span>
<span class="c1">#                              ,min_observations = 10,unbalanced_bound = 0.1)</span>
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3">
<pre><span></span><span class="c1"># del df_train_samp , df_test_samp</span>
<span class="c1"># gc.collect()</span>
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3">
<pre><span></span>
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3">
<pre><span></span><span class="c1">#Transform data using small groups to reduce memory usage</span>
<span class="c1">#m = 100000</span>
<span class="c1">#train = vstack([ohe.transform(train[i*m:(i+1)*m]) for i in range(train.shape[0] // m + 1)])</span>
<span class="c1">#test  = vstack([ohe.transform(test[i*m:(i+1)*m])  for i in range(test.shape[0] // m +  1)])</span>

<span class="c1"># ohe = OneHotEncoder(n_values='auto', sparse=True, dtype='uint8').fit(train)</span>
<span class="c1"># train_sp = ohe.transform(train)</span>
<span class="c1"># test_sp = ohe.transform(test)</span>
<span class="c1"># save_npz('train.npz', train_sp, compressed=True)</span>
<span class="c1"># save_npz('test.npz',  test_sp,  compressed=True)</span>

<span class="c1">#X_train, X_test, y_train, y_test = train_test_split(train_sp,  Y_train, test_size=0.33, random_state=42)</span>
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3">
<pre><span></span><span class="c1">#Train/test split </span>
<span class="n">X_train_d</span><span class="p">,</span> <span class="n">X_test_d</span><span class="p">,</span> <span class="n">y_train_d</span><span class="p">,</span> <span class="n">y_test_d</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">train_t</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
                                                            <span class="p">,</span> <span class="n">y_train_full</span><span class="p">[:</span><span class="mi">1000</span><span class="p">]</span>
                                                            <span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.33</span>
                                                            <span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="c1">#Transform to xgb data type</span>
<span class="n">dtrain</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">DMatrix</span><span class="p">(</span><span class="n">X_train_d</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">y_train_d</span><span class="p">)</span>
<span class="n">dtest</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">DMatrix</span><span class="p">(</span><span class="n">X_test_d</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">y_test_d</span><span class="p">)</span>
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3">
<pre><span></span><span class="c1"># %%time</span>

<span class="c1"># #with a sparse matrix</span>
<span class="c1"># xgb_model = xgb.XGBClassifier(max_depth=6,</span>
<span class="c1">#                                  n_estimators=30000,</span>
<span class="c1">#                                  colsample_bytree=0.2,</span>
<span class="c1">#                                  learning_rate=0.1,</span>
<span class="c1">#                                  objective='binary:logistic', </span>
<span class="c1">#                                  n_jobs=-1)</span>


<span class="c1"># xgb_model.fit(X_train, y_train, eval_metric='auc', </span>
<span class="c1">#              eval_set=[(X_test, y_test)], </span>
<span class="c1">#              verbose=1000, early_stopping_rounds=300)</span>
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3">
<pre><span></span><span class="c1"># # Define default parameters </span>
<span class="c1"># # params = {</span>
<span class="c1"># #     'max_depth': 6,</span>
<span class="c1"># #     'min_child_weight':1,</span>
<span class="c1"># #     'subsample':1,</span>
<span class="c1"># #     'colsample_bytree':1,</span>
<span class="c1"># #     'eta':.3,</span>
<span class="c1"># #     'objective':'binary:logistic',</span>
<span class="c1"># #     'eval_metrics': "rmse"</span>
<span class="c1"># #         }</span>
<span class="c1"># # early_stopping_round = 10</span>
<span class="c1"># # evals = [(dtest, "Test")]</span>
<span class="c1"># # num_boost_round = 999</span>

<span class="c1"># class XGBoostOptimizer:</span>
<span class="c1">#     def __init__(self</span>
<span class="c1">#                  ,dtrain = None</span>
<span class="c1">#                  ,dtest = None</span>
<span class="c1">#                  ,params = {</span>
<span class="c1">#                             'max_depth': 6,</span>
<span class="c1">#                             'min_child_weight':1,</span>
<span class="c1">#                             'subsample':1,</span>
<span class="c1">#                             'colsample_bytree':1,</span>
<span class="c1">#                             'eta':.3,</span>
<span class="c1">#                             'objective':'binary:logistic',</span>
<span class="c1">#                             'eval_metrics': "rmse"</span>
<span class="c1">#                                 }</span>
<span class="c1">#                  ,early_stopping_round = 10</span>
<span class="c1">#                  ,num_boost_round = 999</span>
<span class="c1">#                  ,seed=42</span>
<span class="c1">#                  ,nfold=5</span>
<span class="c1">#                 ):</span>
<span class="c1">#         self.dtrain = dtrain</span>
<span class="c1">#         self.dtest = dtest</span>
<span class="c1">#         self.params = params</span>
<span class="c1">#         self.early_stopping_round = early_stopping_round</span>
<span class="c1">#         self.num_boost_round = num_boost_round</span>
<span class="c1">#         self.seed = seed</span>
<span class="c1">#         self.nfold = nfold</span>
<span class="c1">#         self.stages = ['complexity','feature-samp','learning-rate']</span>

<span class="c1">#     def optimize_tree(self,level='complexity'):</span>
<span class="c1">#         print(f"Level selected = {level}")</span>
<span class="c1">#         if level =='complexity':</span>
<span class="c1">#             #Tuning the complexity of the tree. </span>
<span class="c1">#             #max_depth and min_child_weight should be tuned together</span>
<span class="c1">#             gridsearch_params = [</span>
<span class="c1">#                                     (max_depth, min_child_weight)</span>
<span class="c1">#                                     for max_depth in range(9,12)</span>
<span class="c1">#                                     for min_child_weight in range(5,8)</span>
<span class="c1">#                                 ]</span>
<span class="c1">#             param_to_opt = ['max_depth','min_child_weight']</span>
<span class="c1">#         elif level == 'feature-samp':</span>
<span class="c1">#             gridsearch_params = [</span>
<span class="c1">#                                 (subsample, colsample)</span>
<span class="c1">#                                 for subsample in [i/10. for i in range(7,11)]</span>
<span class="c1">#                                 for colsample in [i/10. for i in range(7,11)]</span>
<span class="c1">#                             ][::-1]</span>
            
<span class="c1">#             param_to_opt = ['subsample','colsample_bytree']</span>
<span class="c1">#         elif level =='learning-rate':</span>
<span class="c1">#             gridsearch_params = [</span>
<span class="c1">#                                 (eta, -1)</span>
<span class="c1">#                                 for eta in [.3, .2, .1, .05, .01, .005]</span>
<span class="c1">#                                 ]</span>
<span class="c1">#             param_to_opt = ['eta','None']</span>
<span class="c1">#         else:</span>
<span class="c1">#             raise Exception("Wrong paramaters")</span>
        
<span class="c1">#         #define initial values</span>
<span class="c1">#         min_mae = float("Inf")</span>
<span class="c1">#         best_params = None</span>
        

<span class="c1">#         cv_params = self.params</span>
<span class="c1">#         print('Solving best parameters ...')</span>
<span class="c1">#         time.sleep(1)</span>
<span class="c1">#         for param0, param1 in tqdm(gridsearch_params):</span>
<span class="c1">#             print(f"CV with {param_to_opt[0]}={param0}, {param_to_opt[1]}={param1}")</span>
<span class="c1">#             # Update our parameters</span>
<span class="c1">#             cv_params[param_to_opt[0]] = param0</span>
<span class="c1">#             if 'eta' not in param_to_opt:</span>
<span class="c1">#                 cv_params[param_to_opt[1]] = param1</span>

<span class="c1">#             # Run CV</span>
<span class="c1">#             cv_results = xgb.cv(</span>
<span class="c1">#                 params = cv_params,</span>
<span class="c1">#                 dtrain = self.dtrain,</span>
<span class="c1">#                 num_boost_round=self.num_boost_round,</span>
<span class="c1">#                 seed=self.seed,</span>
<span class="c1">#                 nfold=self.nfold,</span>
<span class="c1">#                 metrics={'mae'},</span>
<span class="c1">#                 early_stopping_rounds=self.early_stopping_round</span>
<span class="c1">#             )</span>
<span class="c1">#             # Update best MAE</span>
<span class="c1">#             mean_mae = cv_results['test-mae-mean'].min()</span>
<span class="c1">#             boost_rounds = cv_results['test-mae-mean'].argmin()</span>
<span class="c1">#             print("\tMAE {} for {} rounds".format(mean_mae, boost_rounds))</span>
<span class="c1">#             if mean_mae &lt; min_mae:</span>
<span class="c1">#                 min_mae = mean_mae</span>
<span class="c1">#                 best_params = (param0,param1)</span>
<span class="c1">#         print("Best params: {}, {}, MAE: {}".format(best_params[0], best_params[1], min_mae))</span>

<span class="c1">#         self.params[param_to_opt[0]] = best_params[0]</span>
<span class="c1">#         if 'eta' not in param_to_opt:</span>
<span class="c1">#             self.params[param_to_opt[1]] = best_params[1]</span>
            
            
<span class="c1">#     def run_optimizer(self):</span>
<span class="c1">#         for stage in self.stages:</span>
<span class="c1">#             self.optimize_tree(level=stage)</span>
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3">
<pre><span></span>
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3">
<pre><span></span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">XGBoostOptimizer</span><span class="p">(</span><span class="n">dtrain</span><span class="o">=</span><span class="n">dtrain</span>
                             <span class="p">,</span><span class="n">dtest</span><span class="o">=</span><span class="n">dtest</span>
                            <span class="p">,</span><span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">'max_depth'</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
                            <span class="s1">'min_child_weight'</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                            <span class="s1">'subsample'</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                            <span class="s1">'colsample_bytree'</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                            <span class="s1">'eta'</span><span class="p">:</span><span class="mf">.3</span><span class="p">,</span>
                            <span class="s1">'objective'</span><span class="p">:</span><span class="s1">'binary:logistic'</span><span class="p">,</span>
                            <span class="s1">'eval_metrics'</span><span class="p">:</span> <span class="s2">"auc"</span>
                                <span class="p">}</span>
                            <span class="p">,</span><span class="n">cv_metrics</span><span class="o">=</span><span class="s1">'auc'</span>
                            <span class="p">)</span>
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3">
<pre><span></span><span class="c1">#optimizer.optimize_tree(level='complexity')</span>
<span class="n">optimizer</span><span class="o">.</span><span class="n">run_optimizer</span><span class="p">(</span><span class="n">refit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">optimizer</span><span class="o">.</span><span class="n">plot_optimization</span><span class="p">()</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>Level selected = complexity
Solving best parameters ...
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre>  0%|          | 0/9 [00:00&lt;?, ?it/s]</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>CV with max_depth=9, min_child_weight=5
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre> 11%|█         | 1/9 [00:00&lt;00:04,  1.95it/s]</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>	auc 0.615249 for 14 rounds
CV with max_depth=9, min_child_weight=6
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre> 22%|██▏       | 2/9 [00:00&lt;00:03,  2.06it/s]</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>	auc 0.619695 for 8 rounds
CV with max_depth=9, min_child_weight=7
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre> 33%|███▎      | 3/9 [00:01&lt;00:02,  2.34it/s]</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>	auc 0.6114992 for 2 rounds
CV with max_depth=10, min_child_weight=5
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre> 44%|████▍     | 4/9 [00:01&lt;00:02,  2.18it/s]</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>	auc 0.6241859999999999 for 12 rounds
CV with max_depth=10, min_child_weight=6
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre> 56%|█████▌    | 5/9 [00:02&lt;00:01,  2.30it/s]</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>	auc 0.6202018 for 5 rounds
CV with max_depth=10, min_child_weight=7
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre> 67%|██████▋   | 6/9 [00:02&lt;00:01,  2.32it/s]</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>	auc 0.6104512 for 2 rounds
CV with max_depth=11, min_child_weight=5
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre> 78%|███████▊  | 7/9 [00:03&lt;00:00,  2.20it/s]</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>	auc 0.6120056 for 11 rounds
CV with max_depth=11, min_child_weight=6
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre> 89%|████████▉ | 8/9 [00:03&lt;00:00,  2.32it/s]</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>	auc 0.6074927999999999 for 5 rounds
CV with max_depth=11, min_child_weight=7
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre>100%|██████████| 9/9 [00:03&lt;00:00,  2.49it/s]

</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>	auc 0.6104512 for 2 rounds
Best stage params: 10, 5, auc: 0.6241859999999999
Level selected = feature-samp
Solving best parameters ...
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre>  0%|          | 0/16 [00:00&lt;?, ?it/s]</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>CV with subsample=1.0, colsample_bytree=1.0
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre>  6%|▋         | 1/16 [00:00&lt;00:08,  1.84it/s]</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>	auc 0.6241859999999999 for 12 rounds
CV with subsample=1.0, colsample_bytree=0.9
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre> 12%|█▎        | 2/16 [00:01&lt;00:10,  1.30it/s]</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>	auc 0.6099808 for 30 rounds
CV with subsample=1.0, colsample_bytree=0.8
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre> 19%|█▉        | 3/16 [00:02&lt;00:08,  1.48it/s]</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>	auc 0.6060361999999999 for 12 rounds
CV with subsample=1.0, colsample_bytree=0.7
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre> 25%|██▌       | 4/16 [00:02&lt;00:07,  1.64it/s]</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>	auc 0.6250224 for 12 rounds
CV with subsample=0.9, colsample_bytree=1.0
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre> 31%|███▏      | 5/16 [00:03&lt;00:06,  1.69it/s]</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>	auc 0.6075514 for 15 rounds
CV with subsample=0.9, colsample_bytree=0.9
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre> 38%|███▊      | 6/16 [00:03&lt;00:05,  1.68it/s]</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>	auc 0.620186 for 20 rounds
CV with subsample=0.9, colsample_bytree=0.8
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre> 44%|████▍     | 7/16 [00:04&lt;00:05,  1.67it/s]</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>	auc 0.6123138000000001 for 5 rounds
CV with subsample=0.9, colsample_bytree=0.7
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre> 50%|█████     | 8/16 [00:04&lt;00:04,  1.85it/s]</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>	auc 0.6121988 for 9 rounds
CV with subsample=0.8, colsample_bytree=1.0
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre> 56%|█████▋    | 9/16 [00:05&lt;00:03,  2.03it/s]</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>	auc 0.6190234 for 6 rounds
CV with subsample=0.8, colsample_bytree=0.9
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre> 62%|██████▎   | 10/16 [00:05&lt;00:02,  2.27it/s]</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>	auc 0.6374234 for 3 rounds
CV with subsample=0.8, colsample_bytree=0.8
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre> 69%|██████▉   | 11/16 [00:05&lt;00:02,  2.44it/s]</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>	auc 0.6331906 for 3 rounds
CV with subsample=0.8, colsample_bytree=0.7
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre> 75%|███████▌  | 12/16 [00:06&lt;00:01,  2.56it/s]</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>	auc 0.6249306000000001 for 5 rounds
CV with subsample=0.7, colsample_bytree=1.0
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre> 81%|████████▏ | 13/16 [00:06&lt;00:01,  2.71it/s]</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>	auc 0.6159017999999999 for 3 rounds
CV with subsample=0.7, colsample_bytree=0.9
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre> 88%|████████▊ | 14/16 [00:07&lt;00:00,  2.59it/s]</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>	auc 0.6040175999999999 for 10 rounds
CV with subsample=0.7, colsample_bytree=0.8
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre> 94%|█████████▍| 15/16 [00:07&lt;00:00,  2.53it/s]</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>	auc 0.601818 for 11 rounds
CV with subsample=0.7, colsample_bytree=0.7
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre>100%|██████████| 16/16 [00:08&lt;00:00,  2.18it/s]

</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>	auc 0.6218359999999999 for 6 rounds
Best stage params: 0.8, 0.9, auc: 0.6374234
Level selected = learning-rate
Solving best parameters ...
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre>  0%|          | 0/6 [00:00&lt;?, ?it/s]</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>CV with eta=0.3, None=-1
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre> 17%|█▋        | 1/6 [00:00&lt;00:01,  3.18it/s]</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>	auc 0.6374234 for 3 rounds
CV with eta=0.2, None=-1
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre> 33%|███▎      | 2/6 [00:00&lt;00:01,  2.69it/s]</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>	auc 0.6313592 for 9 rounds
CV with eta=0.1, None=-1
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre> 50%|█████     | 3/6 [00:01&lt;00:01,  2.67it/s]</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>	auc 0.624386 for 4 rounds
CV with eta=0.05, None=-1
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre> 67%|██████▋   | 4/6 [00:01&lt;00:00,  2.44it/s]</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>	auc 0.6246558 for 11 rounds
CV with eta=0.01, None=-1
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre> 83%|████████▎ | 5/6 [00:02&lt;00:00,  2.03it/s]</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>	auc 0.6288968 for 12 rounds
CV with eta=0.005, None=-1
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr" tabindex="0">
<pre>100%|██████████| 6/6 [00:02&lt;00:00,  1.98it/s]

</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>	auc 0.6268670000000001 for 12 rounds
Best stage params: 0.3, -1, auc: 0.6374234
Finished optimization.
Best params: {'max_depth': 10, 'min_child_weight': 5, 'subsample': 0.8, 'colsample_bytree': 0.9, 'eta': 0.3, 'objective': 'binary:logistic', 'eval_metrics': 'auc'}
[0]	Test-error:0.415152
Will train until Test-error hasn't improved in 10 rounds.
[1]	Test-error:0.406061
[2]	Test-error:0.424242
[3]	Test-error:0.412121
[4]	Test-error:0.415152
[5]	Test-error:0.390909
[6]	Test-error:0.415152
[7]	Test-error:0.418182
[8]	Test-error:0.390909
[9]	Test-error:0.393939
[10]	Test-error:0.406061
[11]	Test-error:0.378788
[12]	Test-error:0.378788
[13]	Test-error:0.4
[14]	Test-error:0.39697
[15]	Test-error:0.4
[16]	Test-error:0.406061
[17]	Test-error:0.40303
[18]	Test-error:0.406061
[19]	Test-error:0.384848
[20]	Test-error:0.393939
[21]	Test-error:0.39697
Stopping. Best iteration:
[11]	Test-error:0.378788

</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<figure><img alt="No description has been provided for this image" class="" src="{{site.baseurl}}/assets/2019/05/h8g9KIc4kgYDQAAAABJRU5ErkJggg=="></figure>
<div class="jp-RenderedImage jp-OutputArea-output" tabindex="0">
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3">
<pre><span></span><span class="n">xgb_model_d</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">get_best_model</span><span class="p">()</span>
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3">
<pre><span></span><span class="c1"># %%time</span>

<span class="c1"># #with a dense matrix</span>
<span class="c1"># xgb_model_d = xgb.XGBClassifier(max_depth=6,</span>
<span class="c1">#                                  n_estimators=30000,</span>
<span class="c1">#                                  colsample_bytree=0.2,</span>
<span class="c1">#                                  learning_rate=0.1,</span>
<span class="c1">#                                  objective='binary:logistic', </span>
<span class="c1">#                                  n_jobs=-1)</span>


<span class="c1"># xgb_model_d.fit(np.array(X_train_d), y_train_d, eval_metric='auc', </span>
<span class="c1">#              eval_set=[(np.array(X_test_d), y_test_d)], </span>
<span class="c1">#              verbose=1000, early_stopping_rounds=300)</span>
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3">
<pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">X_train_d</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3">
<pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>
<span class="n">xgb</span><span class="o">.</span><span class="n">plot_importance</span><span class="p">(</span><span class="n">xgb_model_d</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">())</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child jp-OutputArea-executeResult">
<div class="jp-OutputPrompt jp-OutputArea-prompt">Out[ ]:</div>
<div class="jp-RenderedText jp-OutputArea-output jp-OutputArea-executeResult" data-mime-type="text/plain" tabindex="0">
<pre>&lt;matplotlib.axes._subplots.AxesSubplot at 0x7fa1139064a8&gt;</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<figure><img alt="No description has been provided for this image" class="" src="{{site.baseurl}}/assets/2019/05/GU1iVAAAAAElFTkSuQmCC"></figure>
<div class="jp-RenderedImage jp-OutputArea-output" tabindex="0">
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3">
<pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">140</span><span class="p">,</span><span class="mi">145</span><span class="p">))</span>
<span class="n">xgb</span><span class="o">.</span><span class="n">plot_tree</span><span class="p">(</span><span class="n">xgb_model_d</span>
              <span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
             <span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">'tree.png'</span><span class="p">)</span>
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3">
<pre><span></span><span class="n">xgb_train_result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="c1">#xgb_train_result[test_index] += a</span>
<span class="n">xgb_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">test_sp</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]</span>
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3">
<pre><span></span>
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In [ ]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3">
<pre><span></span><span class="o">%%</span><span class="n">time</span>
<span class="c1">#Read a full dataset with selected columns</span>


<span class="n">df_work</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_to_train</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">good_columns_dtype</span><span class="p">,</span><span class="n">usecols</span><span class="o">=</span><span class="n">good_columns</span><span class="p">,</span><span class="n">low_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'DF shape: '</span><span class="p">,</span> <span class="n">df_work</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="s1">'DF size:'</span><span class="p">,</span><span class="nb">sum</span><span class="p">(</span><span class="n">df_work</span><span class="o">.</span><span class="n">memory_usage</span><span class="p">())</span><span class="o">/</span><span class="mi">1024</span><span class="o">/</span><span class="mi">1024</span><span class="p">,</span><span class="s1">'Mb</span><span class="se">\n</span><span class="s1">Estimated'</span><span class="p">)</span>
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<p></main><br />
<!-- /wp:html --><br />
</body></html></p>
